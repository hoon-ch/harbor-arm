name: Build Harbor v2.12.1 ARM64

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/build-v2.12.1.yml'

env:
  HARBOR_REPO: goharbor/harbor
  VERSION: v2.12.1

jobs:
  build-harbor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout Harbor repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.HARBOR_REPO }}
          ref: ${{ env.VERSION }}
          path: harbor

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.19'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build base images for ARM64
        working-directory: harbor
        run: |
          echo "========== Building base images for ARM64 =========="

          # Build db image
          docker buildx build \
            --platform linux/arm64 \
            --push \
            -t ${{ secrets.DOCKER_USERNAME }}/harbor-db:${{ env.VERSION }} \
            -t ghcr.io/${{ github.actor }}/harbor-db:${{ env.VERSION }} \
            -f make/photon/db/Dockerfile \
            --build-arg PGBINDIR=/usr/bin \
            .

          # Build redis image
          docker buildx build \
            --platform linux/arm64 \
            --push \
            -t ${{ secrets.DOCKER_USERNAME }}/harbor-redis:${{ env.VERSION }} \
            -t ghcr.io/${{ github.actor }}/harbor-redis:${{ env.VERSION }} \
            -f make/photon/redis/Dockerfile \
            .

      - name: Build Harbor for ARM64
        working-directory: harbor
        run: |
          VERSION_TAG=${{ env.VERSION }}
          DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
          GITHUB_REPO_OWNER=${{ github.actor }}

          echo "========== Preparing build for ARM64 =========="
          echo "Docker Hub username: ${DOCKER_USERNAME}"
          echo "Version: ${VERSION_TAG}"

          # Build for ARM64
          GOARCH=arm64 GOOS=linux make compile COMPILETAG="compile_golangimage"

          echo "========== Building Docker images for ARM64 =========="

          # Build portal
          docker buildx build \
            --platform linux/arm64 \
            --push \
            -t ${DOCKER_USERNAME}/harbor-portal:${VERSION_TAG} \
            -t ghcr.io/${GITHUB_REPO_OWNER}/harbor-portal:${VERSION_TAG} \
            -f make/photon/portal/Dockerfile \
            .

          # Build core
          docker buildx build \
            --platform linux/arm64 \
            --push \
            --build-arg harbor_base_image_version=${VERSION_TAG} \
            -t ${DOCKER_USERNAME}/harbor-core:${VERSION_TAG} \
            -t ghcr.io/${GITHUB_REPO_OWNER}/harbor-core:${VERSION_TAG} \
            -f make/photon/core/Dockerfile \
            .

          # Build jobservice
          docker buildx build \
            --platform linux/arm64 \
            --push \
            --build-arg harbor_base_image_version=${VERSION_TAG} \
            -t ${DOCKER_USERNAME}/harbor-jobservice:${VERSION_TAG} \
            -t ghcr.io/${GITHUB_REPO_OWNER}/harbor-jobservice:${VERSION_TAG} \
            -f make/photon/jobservice/Dockerfile \
            .

          # Build registryctl
          docker buildx build \
            --platform linux/arm64 \
            --push \
            --build-arg harbor_base_image_version=${VERSION_TAG} \
            -t ${DOCKER_USERNAME}/harbor-registryctl:${VERSION_TAG} \
            -t ghcr.io/${GITHUB_REPO_OWNER}/harbor-registryctl:${VERSION_TAG} \
            -f make/photon/registryctl/Dockerfile \
            .

          # Build registry (the problematic one in v2.14.0)
          docker buildx build \
            --platform linux/arm64 \
            --push \
            --build-arg harbor_base_image_version=${VERSION_TAG} \
            -t ${DOCKER_USERNAME}/harbor-registry:${VERSION_TAG} \
            -t ghcr.io/${GITHUB_REPO_OWNER}/harbor-registry:${VERSION_TAG} \
            -f make/photon/registry/Dockerfile \
            .

          # Build nginx
          docker buildx build \
            --platform linux/arm64 \
            --push \
            -t ${DOCKER_USERNAME}/harbor-nginx:${VERSION_TAG} \
            -t ghcr.io/${GITHUB_REPO_OWNER}/harbor-nginx:${VERSION_TAG} \
            -f make/photon/nginx/Dockerfile \
            .

          # Build log
          docker buildx build \
            --platform linux/arm64 \
            --push \
            -t ${DOCKER_USERNAME}/harbor-log:${VERSION_TAG} \
            -t ghcr.io/${GITHUB_REPO_OWNER}/harbor-log:${VERSION_TAG} \
            -f make/photon/log/Dockerfile \
            .

          # Build exporter - using make target in v2.12.1
          if make compile_exporter; then
            echo "✅ Exporter binary compiled successfully"
          else
            echo "⚠️ Warning: Exporter compilation failed, trying alternative method..."
            # Alternative method if make target doesn't exist
            mkdir -p make/photon/exporter
            cd src/cmd/exporter
            CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -v -o ../../../make/photon/exporter/harbor_exporter .
            cd ../../..
          fi

          docker buildx build \
            --platform linux/arm64 \
            --push \
            --build-arg harbor_base_image_version=${VERSION_TAG} \
            -t ${DOCKER_USERNAME}/harbor-exporter:${VERSION_TAG} \
            -t ghcr.io/${GITHUB_REPO_OWNER}/harbor-exporter:${VERSION_TAG} \
            -f make/photon/exporter/Dockerfile \
            .

          echo "========== Build complete! =========="
          echo "Images pushed to:"
          echo "  - Docker Hub: ${DOCKER_USERNAME}/harbor-*:${VERSION_TAG}"
          echo "  - GitHub Container Registry: ghcr.io/${GITHUB_REPO_OWNER}/harbor-*:${VERSION_TAG}"