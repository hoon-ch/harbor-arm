version: '3.8'

# Harbor ARM64 Integration Test Docker Compose
# This compose file is optimized for fast integration testing
# Uses tmpfs for temporary data to avoid disk I/O bottlenecks

services:
  log:
    image: ${DOCKER_USERNAME}/harbor-log:${VERSION_TAG}
    container_name: harbor-log-test
    restart: on-failure:3
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - SETGID
      - SETUID
    tmpfs:
      - /var/log/docker
    networks:
      - harbor-test
    healthcheck:
      test: ["CMD-SHELL", "netstat -ln | grep 10514 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  redis:
    image: ${DOCKER_USERNAME}/redis-photon:${VERSION_TAG}
    container_name: redis-test
    restart: on-failure:3
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    tmpfs:
      - /var/lib/redis
    networks:
      - harbor-test
    depends_on:
      log:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 3s
      timeout: 2s
      retries: 5
      start_period: 5s

  postgresql:
    image: ${DOCKER_USERNAME}/harbor-db:${VERSION_TAG}
    container_name: harbor-db-test
    restart: on-failure:3
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - SETGID
      - SETUID
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root123
      POSTGRES_DB: registry
    tmpfs:
      - /var/lib/postgresql/data
    networks:
      - harbor-test
    depends_on:
      log:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 20s
    shm_size: '256mb'

  registry:
    image: ${DOCKER_USERNAME}/registry-photon:${VERSION_TAG}
    container_name: registry-test
    restart: on-failure:3
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    tmpfs:
      - /storage
    environment:
      REGISTRY_HTTP_ADDR: 0.0.0.0:5000
      REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY: /storage
    networks:
      - harbor-test
    depends_on:
      log:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:5000/v2/ || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 15s

  registryctl:
    image: ${DOCKER_USERNAME}/harbor-registryctl:${VERSION_TAG}
    container_name: registryctl-test
    restart: on-failure:3
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    tmpfs:
      - /storage
    environment:
      CORE_SECRET: test_secret
      JOBSERVICE_SECRET: test_secret
    networks:
      - harbor-test
    depends_on:
      registry:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "netstat -ln | grep 8080 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  core:
    image: ${DOCKER_USERNAME}/harbor-core:${VERSION_TAG}
    container_name: harbor-core-test
    restart: on-failure:3
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID
    tmpfs:
      - /data
    environment:
      CORE_SECRET: test_secret
      JOBSERVICE_SECRET: test_secret
      HARBOR_ADMIN_PASSWORD: Harbor12345
      DATABASE_TYPE: postgresql
      POSTGRESQL_HOST: postgresql
      POSTGRESQL_PORT: 5432
      POSTGRESQL_USERNAME: postgres
      POSTGRESQL_PASSWORD: root123
      POSTGRESQL_DATABASE: registry
      POSTGRESQL_SSLMODE: disable
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ""
      REGISTRY_URL: http://registry:5000
      REGISTRY_CONTROLLER_URL: http://registryctl:8080
      TOKEN_SERVICE_URL: http://core:8080/service/token
      CFG_EXPIRATION: 5
      ADMIRAL_URL: ""
      WITH_NOTARY: "false"
      WITH_TRIVY: "true"
      WITH_CHARTMUSEUM: "false"
      CHART_REPOSITORY_URL: ""
      PORTAL_URL: http://portal:8080
      REGISTRYCTL_URL: http://registryctl:8080
      CORE_URL: http://core:8080
      JOBSERVICE_URL: http://jobservice:8080
      TRIVY_ADAPTER_URL: http://trivy-adapter:8080
      CORE_LOCAL_URL: http://127.0.0.1:8080
    networks:
      - harbor-test
    depends_on:
      log:
        condition: service_healthy
      registry:
        condition: service_healthy
      redis:
        condition: service_healthy
      postgresql:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/api/v2.0/ping || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 30s

  portal:
    image: ${DOCKER_USERNAME}/harbor-portal:${VERSION_TAG}
    container_name: harbor-portal-test
    restart: on-failure:3
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - NET_BIND_SERVICE
    networks:
      - harbor-test
    depends_on:
      log:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/ || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  jobservice:
    image: ${DOCKER_USERNAME}/harbor-jobservice:${VERSION_TAG}
    container_name: harbor-jobservice-test
    restart: on-failure:3
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    tmpfs:
      - /var/log/jobs
    environment:
      CORE_SECRET: test_secret
      JOBSERVICE_SECRET: test_secret
      CORE_URL: http://core:8080
      REGISTRY_URL: http://registry:5000
      REGISTRY_CONTROLLER_URL: http://registryctl:8080
    networks:
      - harbor-test
    depends_on:
      core:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/api/v1/stats || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s

  proxy:
    image: ${DOCKER_USERNAME}/nginx-photon:${VERSION_TAG}
    container_name: nginx-test
    restart: on-failure:3
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - NET_BIND_SERVICE
    networks:
      - harbor-test
    ports:
      - "8080:8080"
      - "8443:8443"
    depends_on:
      registry:
        condition: service_healthy
      core:
        condition: service_healthy
      portal:
        condition: service_healthy
      log:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/ || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  trivy-adapter:
    image: ${DOCKER_USERNAME}/harbor-exporter:${VERSION_TAG}
    container_name: trivy-adapter-test
    restart: on-failure:3
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - SETGID
      - SETUID
    tmpfs:
      - /home/scanner/.cache/trivy
      - /home/scanner/.cache/reports
    networks:
      - harbor-test
    environment:
      SCANNER_TRIVY_CACHE_DIR: "/home/scanner/.cache/trivy"
      SCANNER_TRIVY_REPORTS_DIR: "/home/scanner/.cache/reports"
      SCANNER_REDIS_URL: "redis://redis:6379/5"
      SCANNER_STORE_REDIS_URL: "redis://redis:6379/5"
      SCANNER_JOB_QUEUE_REDIS_URL: "redis://redis:6379/5"
    depends_on:
      redis:
        condition: service_healthy
      log:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "netstat -ln | grep 8080 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

networks:
  harbor-test:
    name: harbor-test
    driver: bridge
